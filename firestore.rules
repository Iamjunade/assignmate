rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       COMMON HELPERS
    ========================== */
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /* =========================
       USERS
    ========================== */
    match /users/{userId} {
      allow read: if isAuthenticated();

      allow create, delete: if isAuthenticated() && isOwner(userId);

      allow update: if isAuthenticated() && (
        isOwner(userId) ||
        (
          // Controlled peer update
          request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasOnly(['projects_completed']) &&
          request.resource.data.projects_completed ==
            resource.data.projects_completed + 1
        )
      );

      match /fcm_tokens/{token} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    /* =========================
       COMMUNITY POSTS
    ========================== */
    match /community_posts/{postId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && request.resource.data.user_id == request.auth.uid;

      allow update: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['likes', 'comments_count'])
      );

      allow delete: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;

      match /comments/{commentId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && request.resource.data.user_id == request.auth.uid;

        allow delete: if isAuthenticated() && (
          resource.data.user_id == request.auth.uid ||
          get(/databases/$(database)/documents/community_posts/$(postId))
            .data.user_id == request.auth.uid
        );
      }
    }

    /* =========================
       CHATS
    ========================== */
    match /chats/{chatId} {

      // Chat participant check (parent document)
      function isChatParticipant() {
        return request.auth.uid in resource.data.participants ||
               resource.data.poster_id == request.auth.uid ||
               resource.data.writer_id == request.auth.uid;
      }

      // Subcollection-safe participant check
      function isParentChatParticipant() {
        let chat = get(
          /databases/$(database)/documents/chats/$(chatId)
        ).data;

        return request.auth.uid in chat.participants ||
               chat.poster_id == request.auth.uid ||
               chat.writer_id == request.auth.uid;
      }

      /* ---- Chat document ---- */
      allow create: if isAuthenticated() && (
        request.resource.data.poster_id == request.auth.uid ||
        request.resource.data.writer_id == request.auth.uid
      );

      allow read, update: if isAuthenticated() && isChatParticipant();

      /* =========================
         CHAT MESSAGES
      ========================== */
      match /messages/{messageId} {

        // Read: only chat members
        allow read: if isAuthenticated() && isParentChatParticipant();

        // Create: sender OR system
        allow create: if isAuthenticated()
          && isParentChatParticipant()
          && (
            request.resource.data.sender_id == request.auth.uid ||
            request.resource.data.sender_id == 'system'
          );

        // Update: read receipts, offer status, etc.
        allow update: if isAuthenticated() && isParentChatParticipant();

        // âœ… DELETE (CRITICAL FIX)
        allow delete: if isAuthenticated()
          && isParentChatParticipant()
          && request.auth.uid == resource.data.sender_id;
      }

      /* =========================
         CHAT FILE METADATA
      ========================== */
      match /files/{fileId} {
        allow read, create: if isAuthenticated() && isParentChatParticipant();
      }
    }

    /* =========================
       ORDERS / PROJECTS
    ========================== */
    match /orders/{orderId} {
      allow read, create, update: if isAuthenticated() && (
        request.auth.uid == resource.data.student_id ||
        request.auth.uid == resource.data.poster_id ||
        request.auth.uid == resource.data.writer_id ||
        request.auth.uid in resource.data.participants
      );
    }

    /* =========================
       CONNECTION REQUESTS
    ========================== */
    match /requests/{requestId} {
      allow create: if isAuthenticated();

      allow read, update: if isAuthenticated() && (
        request.auth.uid == resource.data.fromId ||
        request.auth.uid == resource.data.toId
      );
    }

    /* =========================
       CONNECTIONS
    ========================== */
    match /connections/{connectionId} {
      allow read, create, update, delete: if isAuthenticated()
        && request.auth.uid in resource.data.participants;
    }

    /* =========================
       NOTIFICATIONS
    ========================== */
    match /notifications/{notificationId} {
      allow read, update: if isAuthenticated()
        && resource.data.receiverId == request.auth.uid;

      allow create: if isAuthenticated();
    }

    /* =========================
       AUDIT / SAFETY (ADMIN)
    ========================== */
    match /audit_logs/{logId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if false;
    }

    match /disconnection_logs/{logId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if false;
    }

    match /safety_reports/{reportId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if false;
    }
  }
}
